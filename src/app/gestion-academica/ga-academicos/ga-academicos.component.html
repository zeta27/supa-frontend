<!-- ga-academicos.component.html -->
<div class="iframe-content">

  <!-- Barra de herramientas -->
  <div class="d-flex justify-content-between align-items-center px-3 mb-3">
    <div class="d-flex align-items-center">
      <button 
        mat-raised-button 
        color="primary" 
        (click)="toggleFormulario()"
        [disabled]="estaCargandoAlgo"
        class="me-2">
        <mat-icon>{{ mostrarFormulario ? 'close' : 'add' }}</mat-icon>
        {{ mostrarFormulario ? 'Cancelar' : 'Nuevo Académico' }}
      </button>
    </div>
    
    <!-- Campo de búsqueda -->
    <div class="search-container">
      <mat-form-field appearance="fill" class="search-field">
        <mat-label>Buscar académicos...</mat-label>
        <input 
          matInput 
          placeholder="Buscar por CURP, nombre, NP..."
          [(ngModel)]="searchTerm"
          (input)="filtrarAcademicos()"
          [disabled]="estaCargandoAlgo">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>
  </div>

  <!-- Overlay oscuro -->
  <div *ngIf="mostrarFormulario" class="form-overlay" (click)="toggleFormulario()"></div>

  <!-- Formulario de nuevo académico (flotante) -->
  <div *ngIf="mostrarFormulario" class="px-3 mb-3">
    <mat-card class="form-card">
      <mat-card-header>
        <mat-card-title>
          <div class="title-with-icon">
            <mat-icon>person_add</mat-icon>
            <span>Registrar Nuevo Académico</span>
          </div>
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="form-grid">
          <!-- Sección: Datos Personales -->
          <div class="form-section">
            <h3 class="section-title">Datos Personales</h3>
            <div class="row g-3">
              <div class="col-md-6">
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>CURP *</mat-label>
                  <input 
                    matInput 
                    [(ngModel)]="nuevoAcademico.curp"
                    placeholder="AAAA######HAAAA##"
                    maxlength="18"
                    [disabled]="creating"
                    (input)="nuevoAcademico.curp = nuevoAcademico.curp?.toUpperCase()">
                  <mat-hint>18 caracteres</mat-hint>
                </mat-form-field>
              </div>

              <div class="col-md-6">
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>Número de Personal (NP) *</mat-label>
                  <input 
                    matInput 
                    type="number"
                    [(ngModel)]="nuevoAcademico.np"
                    placeholder="12345"
                    [disabled]="creating">
                </mat-form-field>
              </div>

              <div class="col-md-4">
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>Nombre(s) *</mat-label>
                  <input 
                    matInput 
                    [(ngModel)]="nuevoAcademico.nombre"
                    placeholder="Nombre(s)"
                    maxlength="150"
                    [disabled]="creating">
                </mat-form-field>
              </div>

              <div class="col-md-4">
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>Apellido Paterno</mat-label>
                  <input 
                    matInput 
                    [(ngModel)]="nuevoAcademico.paterno"
                    placeholder="Apellido Paterno"
                    maxlength="150"
                    [disabled]="creating">
                </mat-form-field>
              </div>

              <div class="col-md-4">
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>Apellido Materno</mat-label>
                  <input 
                    matInput 
                    [(ngModel)]="nuevoAcademico.materno"
                    placeholder="Apellido Materno"
                    maxlength="150"
                    [disabled]="creating">
                </mat-form-field>
              </div>

              <div class="col-md-6">
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>Género *</mat-label>
                  <mat-select 
                    [(ngModel)]="nuevoAcademico.idCatGeneros"
                    [disabled]="creating">
                    <mat-option *ngFor="let genero of generos" [value]="genero.idCatGeneros">
                      {{ genero.dGenero }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="col-md-6">
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>Nacionalidad *</mat-label>
                  <mat-select 
                    [(ngModel)]="nuevoAcademico.idCatNacionalidad"
                    [disabled]="creating">
                    <mat-option *ngFor="let nacionalidad of nacionalidades" [value]="nacionalidad.idCatNacionalidad">
                      {{ nacionalidad.dNacionalidad }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>
          </div>

          <!-- Sección: Datos Institucionales -->
          <div class="form-section">
            <h3 class="section-title">Datos Institucionales</h3>
            <div class="row g-3">
              <div class="col-md-6">
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>Institución</mat-label>
                  <input 
                    matInput 
                    [(ngModel)]="nuevoAcademico.institucion"
                    placeholder="Universidad Veracruzana"
                    maxlength="4"
                    [disabled]="creating">
                </mat-form-field>
              </div>

              <div class="col-md-6">
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>Cuenta UV</mat-label>
                  <input 
                    matInput 
                    [(ngModel)]="nuevoAcademico.cuentaUV"
                    placeholder="usuario@uv.mx"
                    maxlength="100"
                    [disabled]="creating">
                </mat-form-field>
              </div>

              <div class="col-md-12">
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>ID PRODEP *</mat-label>
                  <input 
                    matInput 
                    type="number"
                    [(ngModel)]="nuevoAcademico.idPRODEP"
                    placeholder="ID PRODEP"
                    [disabled]="creating">
                </mat-form-field>
              </div>
            </div>
          </div>

          <!-- Sección: Estado y Observaciones -->
          <div class="form-section">
            <h3 class="section-title">Estado y Observaciones</h3>
            <div class="row g-3">
              <div class="col-md-12">
                <mat-checkbox 
                  [(ngModel)]="nuevoAcademico.baja"
                  [disabled]="creating"
                  class="mb-3">
                  Académico dado de baja
                </mat-checkbox>
              </div>

              <div class="col-md-6" *ngIf="nuevoAcademico.baja">
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>Fecha de Baja</mat-label>
                  <input 
                    matInput 
                    [matDatepicker]="picker"
                    [(ngModel)]="nuevoAcademico.fechaBaja"
                    [disabled]="creating">
                  <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                  <mat-datepicker #picker></mat-datepicker>
                </mat-form-field>
              </div>

              <div class="col-md-6" *ngIf="nuevoAcademico.baja">
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>Motivo de Baja</mat-label>
                  <mat-select 
                    [(ngModel)]="nuevoAcademico.idCatMotivos"
                    [disabled]="creating">
                    <mat-option *ngFor="let motivo of motivos" [value]="motivo.idCatMotivos">
                      {{ motivo.dMotivos }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="col-md-12">
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>Observaciones</mat-label>
                  <textarea 
                    matInput 
                    [(ngModel)]="nuevoAcademico.observaciones"
                    placeholder="Observaciones adicionales..."
                    maxlength="250"
                    rows="3"
                    [disabled]="creating"></textarea>
                  <mat-hint align="end">{{ nuevoAcademico.observaciones?.length || 0 }}/250</mat-hint>
                </mat-form-field>
              </div>
            </div>
          </div>
        </div>
      </mat-card-content>
      <mat-card-actions align="end">
        <button 
          mat-button 
          (click)="toggleFormulario()"
          [disabled]="creating">
          Cancelar
        </button>
        <button 
          mat-raised-button 
          color="primary"
          (click)="crearAcademico()"
          [disabled]="!formularioValido || creating">
          <mat-spinner *ngIf="creating" diameter="20" class="me-2"></mat-spinner>
          <mat-icon *ngIf="!creating">save</mat-icon>
          {{ creating ? 'Guardando...' : 'Guardar Académico' }}
        </button>
      </mat-card-actions>
    </mat-card>
  </div>

  <!-- Loading -->
  <div *ngIf="loadingCatalogos" class="SpinnerPosition">
    <div class="InnerSpinner">
      <mat-spinner></mat-spinner>
      <b class="mt-3 g-font-size-14">Cargando catálogos...</b>
    </div>
  </div>

  <!-- Tabla -->
  <div *ngIf="!loadingCatalogos" class="px-3 pb-3">
    <div class="iframe-table-container">
      <div class="SpanBackground">
        <div class="Content">
          <div class="w-100">
            <table mat-table [dataSource]="academicosFiltered" class="iframe-table">

              <!-- Columna: CURP -->
              <ng-container matColumnDef="curp">
                <th mat-header-cell *matHeaderCellDef>CURP</th>
                <td mat-cell *matCellDef="let academico">
                  <div class="academico-info">
                    <span *ngIf="editando?.idSUPA !== academico.idSUPA" class="academico-curp">
                      {{ academico.curp }}
                    </span>
                    <div *ngIf="editando?.idSUPA === academico.idSUPA" class="inline-edit-container">
                      <mat-form-field appearance="outline" class="inline-edit-field">
                        <input 
                          matInput 
                          [(ngModel)]="academicoEditando.curp"
                          maxlength="18"
                          [disabled]="updating">
                      </mat-form-field>
                    </div>
                  </div>
                </td>
              </ng-container>

              <!-- Columna: Nombre Completo -->
              <ng-container matColumnDef="nombreCompleto">
                <th mat-header-cell *matHeaderCellDef>Nombre Completo</th>
                <td mat-cell *matCellDef="let academico">
                  <div class="academico-info">
                    <span *ngIf="editando?.idSUPA !== academico.idSUPA" class="academico-name">
                      {{ academico.nombre }} {{ academico.paterno }} {{ academico.materno }}
                    </span>
                    <div *ngIf="editando?.idSUPA === academico.idSUPA" class="inline-edit-container">
                      <mat-form-field appearance="outline" class="inline-edit-field small">
                        <input 
                          matInput 
                          [(ngModel)]="academicoEditando.nombre"
                          placeholder="Nombre"
                          maxlength="150"
                          [disabled]="updating">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="inline-edit-field small">
                        <input 
                          matInput 
                          [(ngModel)]="academicoEditando.paterno"
                          placeholder="Paterno"
                          maxlength="150"
                          [disabled]="updating">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="inline-edit-field small">
                        <input 
                          matInput 
                          [(ngModel)]="academicoEditando.materno"
                          placeholder="Materno"
                          maxlength="150"
                          [disabled]="updating">
                      </mat-form-field>
                    </div>
                  </div>
                </td>
              </ng-container>

              <!-- Columna: NP -->
              <ng-container matColumnDef="np">
                <th mat-header-cell *matHeaderCellDef>NP</th>
                <td mat-cell *matCellDef="let academico">
                  <div class="academico-info">
                    <span *ngIf="editando?.idSUPA !== academico.idSUPA">
                      {{ academico.np }}
                    </span>
                    <div *ngIf="editando?.idSUPA === academico.idSUPA" class="inline-edit-container">
                      <mat-form-field appearance="outline" class="inline-edit-field small">
                        <input 
                          matInput 
                          type="number"
                          [(ngModel)]="academicoEditando.np"
                          [disabled]="updating">
                      </mat-form-field>
                    </div>
                  </div>
                </td>
              </ng-container>

              <!-- Columna: Cuenta UV -->
              <ng-container matColumnDef="cuentaUV">
                <th mat-header-cell *matHeaderCellDef>Cuenta UV</th>
                <td mat-cell *matCellDef="let academico">
                  <div class="academico-info">
                    <span *ngIf="editando?.idSUPA !== academico.idSUPA">
                      {{ academico.cuentaUV || 'N/A' }}
                    </span>
                    <div *ngIf="editando?.idSUPA === academico.idSUPA" class="inline-edit-container">
                      <mat-form-field appearance="outline" class="inline-edit-field">
                        <input 
                          matInput 
                          [(ngModel)]="academicoEditando.cuentaUV"
                          maxlength="100"
                          [disabled]="updating">
                      </mat-form-field>
                    </div>
                  </div>
                </td>
              </ng-container>

              <!-- Columna: Género -->
              <ng-container matColumnDef="genero">
                <th mat-header-cell *matHeaderCellDef>Género</th>
                <td mat-cell *matCellDef="let academico">
                  <div class="academico-info">
                    <span *ngIf="editando?.idSUPA !== academico.idSUPA">
                      {{ getNombreGenero(academico.idCatGeneros) }}
                    </span>
                    <div *ngIf="editando?.idSUPA === academico.idSUPA" class="inline-edit-container">
                      <mat-form-field appearance="outline" class="inline-edit-select">
                        <mat-select 
                          [(ngModel)]="academicoEditando.idCatGeneros"
                          [disabled]="updating">
                          <mat-option *ngFor="let genero of generos" [value]="genero.idCatGeneros">
                            {{ genero.dGenero }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>
                    </div>
                  </div>
                </td>
              </ng-container>

              <!-- Columna: Nacionalidad -->
              <ng-container matColumnDef="nacionalidad">
                <th mat-header-cell *matHeaderCellDef>Nacionalidad</th>
                <td mat-cell *matCellDef="let academico">
                  <div class="academico-info">
                    <span *ngIf="editando?.idSUPA !== academico.idSUPA">
                      {{ getNombreNacionalidad(academico.idCatNacionalidad) }}
                    </span>
                    <div *ngIf="editando?.idSUPA === academico.idSUPA" class="inline-edit-container">
                      <mat-form-field appearance="outline" class="inline-edit-select">
                        <mat-select 
                          [(ngModel)]="academicoEditando.idCatNacionalidad"
                          [disabled]="updating">
                          <mat-option *ngFor="let nacionalidad of nacionalidades" [value]="nacionalidad.idCatNacionalidad">
                            {{ nacionalidad.dNacionalidad }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>
                    </div>
                  </div>
                </td>
              </ng-container>

              <!-- Columna: Estatus -->
              <ng-container matColumnDef="estatus">
                <th mat-header-cell *matHeaderCellDef>Estatus</th>
                <td mat-cell *matCellDef="let academico">
                  <span class="status-badge" [class.inactive]="academico.baja" [class.active]="!academico.baja">
                    {{ academico.baja ? 'Baja' : 'Activo' }}
                  </span>
                </td>
              </ng-container>

              <!-- Columna: Acciones -->
              <ng-container matColumnDef="acciones">
                <th mat-header-cell *matHeaderCellDef>Acciones</th>
                <td mat-cell *matCellDef="let academico">
                  <div class="d-flex justify-content-center iframe-actions">
                    <ng-container *ngIf="editando?.idSUPA !== academico.idSUPA; else modoEdicion">
                      <button 
                        mat-icon-button 
                        (click)="prepararEdicion(academico)"
                        [disabled]="!puedeEditar"
                        matTooltip="Editar académico">
                        <mat-icon class="text-primary">edit</mat-icon>
                      </button>
                      
                      <button 
                        mat-icon-button
                        (click)="eliminarAcademico(academico.idSUPA)"
                        [disabled]="estaCargandoAlgo"
                        matTooltip="Eliminar académico">
                        <mat-icon class="text-danger">delete</mat-icon>
                      </button>
                    </ng-container>
                    <ng-template #modoEdicion>
                      <button 
                        mat-icon-button 
                        (click)="actualizarAcademico()"
                        [disabled]="updating"
                        matTooltip="Guardar cambios">
                        <mat-spinner *ngIf="updating" diameter="20"></mat-spinner>
                        <mat-icon *ngIf="!updating" class="text-success">save</mat-icon>
                      </button>
                      
                      <button 
                        mat-icon-button
                        (click)="cancelarEdicion()"
                        [disabled]="updating"
                        matTooltip="Cancelar edición">
                        <mat-icon class="text-warning">cancel</mat-icon>
                      </button>
                    </ng-template>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>

            <!-- Mensaje sin datos -->
            <div *ngIf="academicosFiltered.length === 0 && !loadingCatalogos" class="text-center p-4">
              <mat-icon class="no-data-icon">{{ searchTerm ? 'search_off' : 'school' }}</mat-icon>
              <h4 class="g-font-size-16 roboto-medium text-muted mb-2">
                {{ searchTerm ? 'Sin resultados' : 'No hay académicos registrados' }}
              </h4>
              <p class="text-muted g-font-size-14">
                {{ searchTerm ? 'No se encontraron académicos' : 'Agregue el primer académico' }}
              </p>
              <button 
                *ngIf="searchTerm"
                mat-stroked-button
                color="primary"
                (click)="limpiarBusqueda()"
                [disabled]="estaCargandoAlgo">
                <mat-icon>clear</mat-icon>
                Limpiar búsqueda
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>