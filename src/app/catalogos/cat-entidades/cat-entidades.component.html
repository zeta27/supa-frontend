<!-- cat-entidades.component.html -->
<div class="iframe-content">

  <!-- Barra de herramientas -->
  <div class="d-flex justify-content-between align-items-center px-3 mb-3">
    <!-- Formulario de nueva entidad -->
    <div class="form-section d-flex align-items-end">
      <mat-form-field appearance="fill" class="nombre-field me-2">
        <mat-label>Nombre de la entidad</mat-label>
        <input 
          matInput 
          [(ngModel)]="nuevaEntidad.dentidad"
          placeholder="Ingrese el nombre"
          maxlength="50"
          [disabled]="estaCargandoAlgo">
      </mat-form-field>

      <mat-form-field appearance="fill" class="nombre-field me-2">
        <mat-label>Identificador UV</mat-label>
        <input 
          matInput 
          [(ngModel)]="nuevaEntidad.identidadUV"
          placeholder="Ingrese ID UV"
          maxlength="100"
          [disabled]="estaCargandoAlgo">
      </mat-form-field>

      <mat-form-field appearance="fill" class="select-field me-2">
        <mat-label>Área</mat-label>
        <mat-select 
          [(ngModel)]="nuevaEntidad.idCatAreas"
          [disabled]="estaCargandoAlgo">
          <mat-option *ngFor="let area of areas" [value]="area.idCatAreas">
            {{ area.darea }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill" class="select-field me-2">
        <mat-label>Región</mat-label>
        <mat-select 
          [(ngModel)]="nuevaEntidad.idCatRegion"
          [disabled]="estaCargandoAlgo">
          <mat-option *ngFor="let region of regiones" [value]="region.idCatRegion">
            {{ region.dregion || 'Sin nombre' }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      
      <button 
        type="button"
        mat-icon-button
        color="primary" 
        class="add-button"
        (click)="crearEntidad()"
        [disabled]="!formularioValido || estaCargandoAlgo"
        matTooltip="Agregar nueva entidad">
        <mat-spinner *ngIf="creating" diameter="20"></mat-spinner>
        <mat-icon *ngIf="!creating">add</mat-icon>
      </button>
    </div>
    
    <!-- Campo de búsqueda -->
    <div class="search-container">
      <mat-form-field appearance="fill" class="search-field">
        <mat-label>Buscar entidades...</mat-label>
        <input 
          matInput 
          placeholder="Buscar por nombre, área, región..."
          [(ngModel)]="searchTerm"
          (input)="filtrarEntidades()"
          [disabled]="estaCargandoAlgo">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loadingCatalogos" class="SpinnerPosition">
    <div class="InnerSpinner">
      <mat-spinner></mat-spinner>
      <b class="mt-3 g-font-size-14">Cargando entidades...</b>
    </div>
  </div>

  <!-- Tabla -->
  <div *ngIf="!loadingCatalogos" class="px-3 pb-3">
    <div class="iframe-table-container">
      <div class="SpanBackground">
        <span class="title-table">
          <mat-icon>business</mat-icon>
          Catálogo de Entidades
        </span>
      </div>
      
      <div class="Content">
        <table mat-table [dataSource]="entidadesFiltered" class="iframe-table">

          <!-- Columna: Nombre de Entidad -->
          <ng-container matColumnDef="dentidad">
            <th mat-header-cell *matHeaderCellDef class="text-center">
              <strong>NOMBRE</strong>
            </th>
            <td mat-cell *matCellDef="let entidad" class="text-center">
              <mat-form-field 
                *ngIf="editando?.idCatEntidades === entidad.idCatEntidades; else showDentidad"
                appearance="fill" 
                class="inline-edit-field">
                <input 
                  matInput 
                  [(ngModel)]="entidadEditando.dentidad"
                  maxlength="50"
                  [disabled]="updating">
              </mat-form-field>
              <ng-template #showDentidad>
                <span>{{ entidad.dentidad }}</span>
              </ng-template>
            </td>
          </ng-container>

          <!-- Columna: Identificador UV -->
          <ng-container matColumnDef="identidadUV">
            <th mat-header-cell *matHeaderCellDef class="text-center">
              <strong>ID UV</strong>
            </th>
            <td mat-cell *matCellDef="let entidad" class="text-center">
              <mat-form-field 
                *ngIf="editando?.idCatEntidades === entidad.idCatEntidades; else showIdentidadUV"
                appearance="fill" 
                class="inline-edit-field">
                <input 
                  matInput 
                  [(ngModel)]="entidadEditando.identidadUV"
                  maxlength="100"
                  [disabled]="updating">
              </mat-form-field>
              <ng-template #showIdentidadUV>
                <span>{{ entidad.identidadUV }}</span>
              </ng-template>
            </td>
          </ng-container>

          <!-- Columna: Área -->
          <ng-container matColumnDef="area">
            <th mat-header-cell *matHeaderCellDef class="text-center">
              <strong>ÁREA</strong>
            </th>
            <td mat-cell *matCellDef="let entidad" class="text-center">
              <mat-form-field 
                *ngIf="editando?.idCatEntidades === entidad.idCatEntidades; else showArea"
                appearance="fill" 
                class="inline-edit-select">
                <mat-select 
                  [(ngModel)]="entidadEditando.idCatAreas"
                  [disabled]="updating">
                  <mat-option *ngFor="let area of areas" [value]="area.idCatAreas">
                    {{ area.darea }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <ng-template #showArea>
                <span>{{ getNombreArea(entidad.idCatAreas) }}</span>
              </ng-template>
            </td>
          </ng-container>

          <!-- Columna: Región -->
          <ng-container matColumnDef="region">
            <th mat-header-cell *matHeaderCellDef class="text-center">
              <strong>REGIÓN</strong>
            </th>
            <td mat-cell *matCellDef="let entidad" class="text-center">
              <mat-form-field 
                *ngIf="editando?.idCatEntidades === entidad.idCatEntidades; else showRegion"
                appearance="fill" 
                class="inline-edit-select">
                <mat-select 
                  [(ngModel)]="entidadEditando.idCatRegion"
                  [disabled]="updating">
                  <mat-option *ngFor="let region of regiones" [value]="region.idCatRegion">
                    {{ region.dregion || 'Sin nombre' }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <ng-template #showRegion>
                <span>{{ getNombreRegion(entidad.idCatRegion) }}</span>
              </ng-template>
            </td>
          </ng-container>

          <!-- Columna: Acciones -->
          <ng-container matColumnDef="acciones">
            <th mat-header-cell *matHeaderCellDef class="text-center">
              <strong>ACCIONES</strong>
            </th>
            <td mat-cell *matCellDef="let entidad" class="text-center">
              <div class="action-buttons">
                <!-- Modo Visualización -->
                <ng-container *ngIf="editando?.idCatEntidades !== entidad.idCatEntidades">
                  <button 
                    mat-icon-button 
                    color="primary"
                    (click)="prepararEdicion(entidad)"
                    [disabled]="!puedeEditar"
                    matTooltip="Editar entidad">
                    <mat-icon>edit</mat-icon>
                  </button>
                  
                  <button 
                    mat-icon-button 
                    color="warn"
                    (click)="eliminarEntidad(entidad.idCatEntidades)"
                    [disabled]="estaCargandoAlgo"
                    matTooltip="Eliminar entidad">
                    <mat-spinner *ngIf="deleting" diameter="20"></mat-spinner>
                    <mat-icon *ngIf="!deleting">delete</mat-icon>
                  </button>
                </ng-container>

                <!-- Modo Edición -->
                <ng-container *ngIf="editando?.idCatEntidades === entidad.idCatEntidades">
                  <button 
                    mat-icon-button 
                    color="primary"
                    (click)="actualizarEntidad()"
                    [disabled]="updating"
                    matTooltip="Guardar cambios">
                    <mat-spinner *ngIf="updating" diameter="20"></mat-spinner>
                    <mat-icon *ngIf="!updating">save</mat-icon>
                  </button>
                  
                  <button 
                    mat-icon-button 
                    color="warn"
                    (click)="cancelarEdicion()"
                    [disabled]="updating"
                    matTooltip="Cancelar">
                    <mat-icon>cancel</mat-icon>
                  </button>
                </ng-container>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>

        <!-- Sin resultados -->
        <div *ngIf="entidadesFiltered.length === 0" class="no-results">
          <mat-icon>search_off</mat-icon>
          <p><strong>No se encontraron entidades</strong></p>
          <p class="text-muted">
            {{ searchTerm ? 'Intenta con otros términos de búsqueda' : 'Agrega la primera entidad usando el formulario' }}
          </p>
        </div>
      </div>
    </div>
  </div>
</div>