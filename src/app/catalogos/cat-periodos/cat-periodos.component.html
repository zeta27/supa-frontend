<!-- cat-periodos.component.html -->
<div class="iframe-content">

  <!-- Barra de herramientas -->
  <div class="d-flex justify-content-between align-items-center px-3 mb-3">
    <!-- Formulario de nuevo periodo -->
    <div class="form-section d-flex align-items-end">
      <mat-form-field appearance="fill" class="descripcion-field me-2">
        <mat-label>Descripción del periodo</mat-label>
        <input 
          matInput 
          [(ngModel)]="nuevoPeriodo.descripcionPeriodo"
          placeholder="Ej: Enero-Junio 2025"
          maxlength="100"
          [disabled]="estaCargandoAlgo">
      </mat-form-field>

      <mat-form-field appearance="fill" class="fecha-field me-2">
        <mat-label>Fecha Inicio</mat-label>
        <input 
          matInput 
          [matDatepicker]="pickerInicio"
          [(ngModel)]="nuevoPeriodo.fechaInicio"
          [disabled]="estaCargandoAlgo">
        <mat-datepicker-toggle matSuffix [for]="pickerInicio"></mat-datepicker-toggle>
        <mat-datepicker #pickerInicio></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="fill" class="fecha-field me-2">
        <mat-label>Fecha Término</mat-label>
        <input 
          matInput 
          [matDatepicker]="pickerTermino"
          [(ngModel)]="nuevoPeriodo.fechaTermino"
          [disabled]="estaCargandoAlgo">
        <mat-datepicker-toggle matSuffix [for]="pickerTermino"></mat-datepicker-toggle>
        <mat-datepicker #pickerTermino></mat-datepicker>
      </mat-form-field>
      
      <button 
        type="button"
        mat-icon-button
        color="primary" 
        class="add-button"
        (click)="crearPeriodo()"
        [disabled]="!formularioValido || estaCargandoAlgo"
        matTooltip="Agregar nuevo periodo">
        <mat-spinner *ngIf="creating" diameter="20"></mat-spinner>
        <mat-icon *ngIf="!creating">add</mat-icon>
      </button>
    </div>
    
    <!-- Campo de búsqueda -->
    <div class="search-container">
      <mat-form-field appearance="fill" class="search-field">
        <mat-label>Buscar periodos...</mat-label>
        <input 
          matInput 
          placeholder="Buscar por descripción, fechas o ID..."
          [(ngModel)]="searchTerm"
          (input)="filtrarPeriodos()"
          [disabled]="estaCargandoAlgo">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="SpinnerPosition">
    <div class="InnerSpinner">
      <mat-spinner></mat-spinner>
      <b class="mt-3 g-font-size-14">Cargando periodos...</b>
    </div>
  </div>

  <!-- Tabla -->
  <div *ngIf="!loading" class="px-3 pb-3">
    <div class="iframe-table-container">
      <div class="SpanBackground">
        <div class="Content">
          <div class="w-100">
            <table mat-table [dataSource]="periodosFiltered" class="iframe-table">
              
              <!-- Columna Descripción -->
              <ng-container matColumnDef="descripcion">
                <th mat-header-cell *matHeaderCellDef>Descripción del Periodo</th>
                <td mat-cell *matCellDef="let periodo">
                  <div class="periodo-info">
                    <span *ngIf="editando?.idCatPeriodos !== periodo.idCatPeriodos" class="periodo-name">
                      {{ periodo.descripcionPeriodo }}
                    </span>
                    <div *ngIf="editando?.idCatPeriodos === periodo.idCatPeriodos" class="inline-edit-container">
                      <mat-form-field appearance="outline" class="inline-edit-field">
                        <input 
                          matInput 
                          [(ngModel)]="periodoEditando.descripcionPeriodo"
                          placeholder="Descripción del periodo"
                          maxlength="100"
                          [disabled]="updating">
                      </mat-form-field>
                    </div>
                  </div>
                </td>
              </ng-container>

              <!-- Columna Fecha Inicio -->
              <ng-container matColumnDef="fechaInicio">
                <th mat-header-cell *matHeaderCellDef>Fecha Inicio</th>
                <td mat-cell *matCellDef="let periodo">
                  <div class="fecha-info">
                    <span *ngIf="editando?.idCatPeriodos !== periodo.idCatPeriodos">
                      {{ formatearFecha(periodo.fechaInicio) }}
                    </span>
                    <div *ngIf="editando?.idCatPeriodos === periodo.idCatPeriodos">
                      <mat-form-field appearance="outline" class="inline-edit-fecha">
                        <input 
                          matInput 
                          [matDatepicker]="pickerEditInicio"
                          [(ngModel)]="periodoEditando.fechaInicio"
                          [disabled]="updating">
                        <mat-datepicker-toggle matSuffix [for]="pickerEditInicio"></mat-datepicker-toggle>
                        <mat-datepicker #pickerEditInicio></mat-datepicker>
                      </mat-form-field>
                    </div>
                  </div>
                </td>
              </ng-container>

              <!-- Columna Fecha Término -->
              <ng-container matColumnDef="fechaTermino">
                <th mat-header-cell *matHeaderCellDef>Fecha Término</th>
                <td mat-cell *matCellDef="let periodo">
                  <div class="fecha-info">
                    <span *ngIf="editando?.idCatPeriodos !== periodo.idCatPeriodos">
                      {{ formatearFecha(periodo.fechaTermino) }}
                    </span>
                    <div *ngIf="editando?.idCatPeriodos === periodo.idCatPeriodos">
                      <mat-form-field appearance="outline" class="inline-edit-fecha">
                        <input 
                          matInput 
                          [matDatepicker]="pickerEditTermino"
                          [(ngModel)]="periodoEditando.fechaTermino"
                          [disabled]="updating">
                        <mat-datepicker-toggle matSuffix [for]="pickerEditTermino"></mat-datepicker-toggle>
                        <mat-datepicker #pickerEditTermino></mat-datepicker>
                      </mat-form-field>
                    </div>
                  </div>
                </td>
              </ng-container>

              <!-- Columna Acciones -->
              <ng-container matColumnDef="acciones">
                <th mat-header-cell *matHeaderCellDef>Acciones</th>
                <td mat-cell *matCellDef="let periodo">
                  <div class="d-flex justify-content-center iframe-actions">
                    <ng-container *ngIf="editando?.idCatPeriodos !== periodo.idCatPeriodos; else modoEdicion">
                      <button 
                        mat-icon-button 
                        (click)="prepararEdicion(periodo)"
                        [disabled]="!puedeEditar"
                        matTooltip="Editar periodo">
                        <mat-icon class="text-primary">edit</mat-icon>
                      </button>
                      
                      <button 
                        mat-icon-button
                        (click)="eliminarPeriodo(periodo.idCatPeriodos)"
                        [disabled]="estaCargandoAlgo"
                        matTooltip="Eliminar periodo">
                        <mat-icon class="text-danger">delete</mat-icon>
                      </button>
                    </ng-container>
                    <ng-template #modoEdicion>
                      <button 
                        mat-icon-button 
                        (click)="actualizarPeriodo()"
                        [disabled]="updating || !periodoEditando.descripcionPeriodo?.trim()"
                        matTooltip="Guardar cambios">
                        <mat-spinner *ngIf="updating" diameter="20"></mat-spinner>
                        <mat-icon *ngIf="!updating" class="text-success">save</mat-icon>
                      </button>
                      
                      <button 
                        mat-icon-button
                        (click)="cancelarEdicion()"
                        [disabled]="updating"
                        matTooltip="Cancelar edición">
                        <mat-icon class="text-warning">cancel</mat-icon>
                      </button>
                    </ng-template>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>

            <!-- Mensaje sin datos -->
            <div *ngIf="periodosFiltered.length === 0 && !loading" class="text-center p-4">
              <mat-icon class="no-data-icon">{{ searchTerm ? 'search_off' : 'date_range' }}</mat-icon>
              <h4 class="g-font-size-16 roboto-medium text-muted mb-2">
                {{ searchTerm ? 'Sin resultados' : 'No hay periodos registrados' }}
              </h4>
              <p class="text-muted g-font-size-14">
                {{ searchTerm ? 'No se encontraron periodos' : 'Agregue el primer periodo' }}
              </p>
              <button 
                *ngIf="searchTerm"
                mat-stroked-button
                color="primary"
                (click)="limpiarBusqueda()"
                [disabled]="estaCargandoAlgo">
                <mat-icon>clear</mat-icon>
                Limpiar búsqueda
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>